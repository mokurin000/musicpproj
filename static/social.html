<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ä¹äº’åŠ¨ç¤¾åŒº</title>
    <link rel="stylesheet" href="/static/syt.css">
</head>

<body>
    <nav class="nav">
        <a href="/">é¦–é¡µ</a>
        <a href="/play_midi">æ’­æ”¾</a>
        <a href="/login">ç™»å½•</a>
        <a href="/register">æ³¨å†Œ</a>
        <a href="/profile">ä¸ªäºº</a>
        <a href="/social">ç¤¾äº¤</a>
    </nav>
    <div class="header">
        <h1>éŸ³ä¹äº’åŠ¨ç¤¾åŒº</h1>
        <div>
            <a href="/profile" style="margin-right:1rem;">æˆ‘çš„æ–‡ä»¶</a>
        </div>
    </div>

    <div id="socialFeed">
        <div class="loading">åŠ è½½ä¸­...</div>
    </div>

    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        fetch('/api/check_login', {
            credentials: 'include'
        })
            .then(res => res.json())
            .then(data => {
                if (!data.logged_in) {
                    window.location.href = '/login';
                } else {
                    loadSocialFeed();
                }
            });

        // åŠ è½½ç¤¾äº¤åŠ¨æ€
        function loadSocialFeed() {
            fetch('/api/feed', {
                credentials: 'include'
            })
                .then(res => {
                    if (!res.ok) throw new Error('åŠ è½½åŠ¨æ€å¤±è´¥');
                    return res.json();
                })
                .then(posts => {
                    const currentUserId = ""; // è¿™é‡Œéœ€è¦æ ¹æ®ä½ çš„ç™»å½•çŠ¶æ€è·å–å½“å‰ç”¨æˆ·çš„ID
                    const container = document.getElementById('socialFeed');
                    container.innerHTML = posts.map(post => `
                    <div class="post">
                        <div class="post-header">
                            <h3 class="post-title">${post.title}</h3>
                            <div class="post-meta">
                                <span>ä½œè€…ï¼š${post.author}</span>
                            </div>
                        </div>
                        <div class="post-stats">
                            <span>â¤ï¸ ${post.likes_count} ç‚¹èµ</span>
                            <span>ğŸ’¬ ${post.comments_count} è¯„è®º</span>
                            <span>ğŸ•’ ${new Date(post.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="actions">
                            <button onclick="toggleLike('${post.social_id}', this)" ${post.is_liked ? 'class="active-like"' : ''}>
                                ${post.is_liked ? 'å–æ¶ˆç‚¹èµ' : 'ç‚¹èµ'}
                            </button>
                            <button onclick="toggleComments(this)">æ˜¾ç¤ºè¯„è®º</button>
                             <button onclick="downloadFile('${post.task_id}')">ä¸‹è½½MIDI</button>
                        </div>
                        <div class="comments" style="display:none;">
                            <div class="comment-list">${renderComments(post.comments)}</div>
                            <div class="comment-input">
                                <textarea placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."></textarea>
                                <button onclick="postComment('${post.social_id}', this)">å‘å¸ƒ</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                })
                .catch(error => {
                    alert(error.message);
                    window.location.href = '/login';
                });
        }

        function toggleLike(postId, button) {
            const isLiked = button.classList.contains('active-like');

            fetch(`/api/like/${postId}`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: isLiked ? 'unlike' : 'like' })
            })
                .then(async res => {
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message || 'æ“ä½œå¤±è´¥');

                    // æ›´æ–°ç‚¹èµæ•°å’ŒæŒ‰é’®çŠ¶æ€
                    const postElement = button.closest('.post');
                    const likesSpan = postElement.querySelector('.post-stats span:first-child');
                    likesSpan.textContent = `â¤ï¸ ${data.likes_count} ç‚¹èµ`;

                    button.classList.toggle('active-like');
                    button.textContent = button.classList.contains('active-like') ? 'å–æ¶ˆç‚¹èµ' : 'ç‚¹èµ';
                })
                .catch(error => {
                    alert(error.message);
                    loadSocialFeed(); // åˆ·æ–°æ•°æ®ä¿è¯ä¸€è‡´æ€§
                });
        }

        function postComment(postId, button) {
            // è·å–DOMå…ƒç´ 
            const textarea = button.previousElementSibling;
            const content = textarea.value.trim();

            // å‰ç«¯éªŒè¯
            if (!content) {
                alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
                return;
            }

            // å‘é€è¯·æ±‚
            fetch(`/api/comment/${postId}`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content })
            })
                .then(async res => {
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message || 'è¯„è®ºå¤±è´¥');

                    // åŠ¨æ€æ’å…¥æ–°è¯„è®º
                    const commentList = button.closest('.comments')
                        .querySelector('.comment-list');
                    commentList.innerHTML += `
                    <div class="comment" data-comment-id="${data.new_comment.comment_id}">
                        <strong>${data.new_comment.author}</strong>
                        <span>${new Date(data.new_comment.time).toLocaleString()}</span>
                        <p>${data.new_comment.content}</p>
                        ${data.new_comment.can_delete ? `
                        <button class="delete-btn" onclick="deleteComment('${comment.comment_id}')">
                            åˆ é™¤
                        </button>
                        ` : ''}
                    </div>
                `;
                    textarea.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                })
                .catch(error => {
                    alert(error.message);
                    loadSocialFeed(); // å¤±è´¥æ—¶åˆ·æ–°æ•´ä¸ªåˆ—è¡¨
                });
        }

        // ä¿®æ”¹åˆ é™¤å‡½æ•°ï¼Œæ·»åŠ å¯¹å“åº”ç±»å‹çš„æ£€æŸ¥
        function deleteComment(commentId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) return;

            fetch(`/api/comment/${commentId}`, { // ç¡®ä¿è¿™ä¸ªURLä¸åç«¯è·¯ç”±åŒ¹é…
                method: 'DELETE',
                credentials: 'include'
            })
                .then(async res => {
                    try {
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.message || 'åˆ é™¤å¤±è´¥');

                        // ç²¾ç¡®åˆ é™¤DOMå…ƒç´ 
                        const commentElement = document.querySelector(
                            `[data-comment-id="${commentId}"]`
                        );
                        commentElement?.remove();
                    } catch (error) {
                        if (res.status === 200) {
                            // å¦‚æœå“åº”ä¸æ˜¯ JSON ä½†çŠ¶æ€ç æ˜¯ 200ï¼Œè®¤ä¸ºåˆ é™¤æˆåŠŸ
                            const commentElement = document.querySelector(
                                `[data-comment-id="${commentId}"]`
                            );
                            commentElement?.remove();
                        } else {
                            throw error;
                        }
                    }
                })
                .catch(error => {
                    alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
                    loadSocialFeed(); // å¤±è´¥æ—¶åˆ·æ–°æ•´ä¸ªåˆ—è¡¨
                });
        }

        function downloadFile(taskId) {
            fetch(`/api/get_midi_id/${taskId}`, {  // è·å–MIDIæ–‡ä»¶çš„ID
                credentials: 'include'
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        console.log("Preparing to download:", data.file_id);
                        window.location.href = `/download/${data.file_id}`;  // è·³è½¬åˆ°ä¸‹è½½è·¯ç”±
                    } else {
                        throw new Error(data.message || "è·å–æ–‡ä»¶IDå¤±è´¥");
                    }
                })
                .catch(error => {
                    console.error('ä¸‹è½½å¤±è´¥:', error);
                    alert('ä¸‹è½½å¤±è´¥: ' + error.message);
                });
        }

        function renderComments(comments) {
            return comments.map(comment => {
                // è¿™é‡Œéœ€è¦æ ¹æ®ä½ çš„åç«¯è¿”å›çš„æ•°æ®ç»“æ„è°ƒæ•´
                const canDelete = comment.can_delete;

                return `
                    <div class="comment" data-comment-id="${comment.comment_id}">
                        <div class="comment-header">
                            <span>${comment.username}</span>
                            ${canDelete ? `
                            <button class="delete-btn" onclick="deleteComment('${comment.comment_id}')">
                                åˆ é™¤
                            </button>` : ''}
                        </div>
                        <p>${comment.content}</p>
                        <span>${new Date(comment.created_at).toLocaleString()}</span>
                    </div>
                `;
            }).join('');
        }

        // åˆ‡æ¢è¯„è®ºæ˜¾ç¤º
        function toggleComments(button) {
            const comments = button.closest('.post').querySelector('.comments');
            comments.style.display = comments.style.display === 'none' ? 'block' : 'none';
        }

        // é€€å‡ºç™»å½•
        function logout() {
            fetch('/api/logout', {
                method: 'POST',
                credentials: 'include'
            })
                .then(() => window.location.href = '/login')
                .catch(error => alert('é€€å‡ºå¤±è´¥: ' + error.message));
        }
    </script>
</body>

</html>